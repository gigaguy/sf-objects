public class FormsTriggerHandler {
    public void beforeInsert(List<Forms__c> forms){
        updateFormLookups(forms, true);
    }
    
    public void beforeUpdate(Map<id,Forms__c> formMap){
        updateFormLookups(formMap.values(), false);
    }
    
    private void updateFormLookups(List<Forms__c> forms, boolean onInsert){
        Boolean useContact = Contact_Approvers__c.getValues('Use Contact Fields').Use_Contact__c; // checkbox from "Contact Approvers" Custom Setting
        Set<id> uIds = new Set<id>();
        Set<String> lanIds = new Set<String>();
        Map<id, Contact> contactMap = new Map<id, Contact>();
        if (!onInsert) for (Forms__c form : forms) uIds.add(form.Unauthenticated_Owner__c == null ? form.OwnerID : form.Unauthenticated_Owner__c);
        else for (Forms__c form : forms) uIds.add(form.Unauthenticated_Owner__c == null ? userInfo.getUserID() : form.Unauthenticated_Owner__c);
            
        Map<id, User> userMap = new Map<id, User>([select id, 
                                                            Supervisor__c, 
                                                            Supervisor_2__c, 
                                                            Time_Keeper__c, 
                                                            Training_Officer__c, 
                                                            Funding_Official__c,
                                                            Email,
                                                            LAN_ID__c 				    // Lan_ID__c exists on both Users and Contacts, 
                                                            							// used to match records
                                                        from User where id in :uIDs]);
        
        if(!useContact){ 
        for (forms__c form : forms){ // start update from User fields loop
            user u;
            if (!onInsert) u =userMap.get(form.Unauthenticated_Owner__c == null ? form.OwnerID : form.Unauthenticated_Owner__c);
            else u =userMap.get(form.Unauthenticated_Owner__c == null ? userInfo.getUserID() : form.Unauthenticated_Owner__c);
            if (u != null){
                form.User_supervisor__c = u.Supervisor__c;
                form.User_Supervisor_2__c = u.Supervisor_2__c;
                form.User_Time_Keeper__c = u.Time_Keeper__c;
                form.User_Training_Officer__c = u.Training_Officer__c;
                form.User_Funding_Official__c = u.Funding_Official__c;
                form.Unlicensed_Owner_Email__c = u.Email;
            	}
        	} // end update from User fields loop
        }
    	else {
	     // get related Contacts
	    	for (user u : userMap.values()) {  // collecting Lan_ID__c values from Users to find matching Contacts
	    		   lanIds.add(u.Lan_ID__c);
	    		}
			contactMap.putAll([select id, 
                                Supervisor__c, 
                                Supervisor_2__c, 
                                Time_Keeper__c, 
                                Training_Officer__c, 
                                Funding_Official__c,
                                Email,
                                LAN_ID__c 
                            from Contact where Lan_ID__c in :lanIDs]);
                            
		Map<string,id> lanMap = new Map<string,id>();    // Map of Lan_ID__c and Contact to match with Users (Form owners)
		for (contact c : contactMap.values()) lanMap.put(c.Lan_ID__c, c.id);	   
    	for (forms__c form : forms){ // start update from Contact fields loop
            User u;
            Contact c;
            String lan;
            if (!onInsert) u =userMap.get(form.Unauthenticated_Owner__c == null ? form.OwnerID : form.Unauthenticated_Owner__c);
            else u =userMap.get(form.Unauthenticated_Owner__c == null ? userInfo.getUserID() : form.Unauthenticated_Owner__c);
            lan = lanMap.get(u.Lan_ID__c);  // gets Contact ID based on Lan_ID__c
            c = contactMap.get(lan);
            if (c != null){
                form.User_supervisor__c = c.Supervisor__c;
                form.User_Supervisor_2__c = c.Supervisor_2__c;
                form.User_Time_Keeper__c = c.Time_Keeper__c;
                form.User_Training_Officer__c = c.Training_Officer__c;
                form.User_Funding_Official__c = c.Funding_Official__c;
                form.Unlicensed_Owner_Email__c = c.Email;
            }
        } // end update from Contact fields loop
    	}    
    }
    
    public void afterUpdate(Map<id,Forms__c> formMap){
        
        createFormShares(formMap.keyset());
       
        /*List<Forms__Share> formShares = new List<Forms__Share>();
        for (id formID : formIdToPeopleIds.keyset()){
            Set<id> usedPeople = new Set<id>();
            for (id personID: formIdToPeopleIds.get(formId)){
                if (!usedPeople.contains(personid)){
                    formShares.add(new Forms__Share(ParentID = formId, UserorGroupID = personid, AccessLevel = 'edit'));
                    usedPeople.adD(personId);
                }
            }
        }
        
        database.insert(formShares, false);*/
    }
    
    @future
    // Shares Form record with Approvers
    public static void createFormShares(Set<id> mainIds){
        List<ProcessInstance> processInstances = [SELECT Id, (SELECT Id, ActorID,TargetObjectId, isPending, StepStatus, Comments FROM StepsAndWorkitems) FROM ProcessInstance where TargetObjectId in :mainIds];
        
        Map<id, List<id>> formIdToPeopleIds = new Map<id, List<id>>();
        for (ProcessInstance pi : processInstances){
            for (ProcessInstanceHistory pih : pi.StepsAndWorkItems){
                system.debug(pih);
                //if (pih.isPending){
                    if (!formIdToPeopleIds.containsKey(pih.TargetObjectID) ){
                        formIdToPeopleIds.put(pih.TargetObjectId, new List<Id>{pih.ActorId});
                    }
                    else{
                        formIdToPeopleIds.get(pih.TargetObjectId).add(pih.ActorId);                        
                    }
                //}
            }
        }
        List<id> formIds = new List<Id>();
        List<id> personIDs = new List<id>();
        for (id formID : formIdToPeopleIds.keyset()){
            for (id personID: formIdToPeopleIds.get(formId)){
                formIDs.add(formID);
                personIds.add(personID);
            }
        }
        
        List<Forms__Share> formShares = new List<Forms__Share>();
        for (Integer i = 0; i < formIds.size();i++){
            formShares.add(new Forms__Share(ParentID = formIds[i], UserorGroupID = personids[i], AccessLevel = 'edit'));
            
        }
        
        database.insert(formShares, false);
    }
}